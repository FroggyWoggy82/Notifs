<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Push Notification Subscription Manager</title>
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        body {
            background-color: #121212;
            color: #ffffff;
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #1e1e1e;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        h1, h2 {
            color: #ffffff;
            margin-top: 0;
        }
        .card {
            background-color: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .button:hover {
            background-color: #45a049;
        }
        .button.danger {
            background-color: #f44336;
        }
        .button.danger:hover {
            background-color: #d32f2f;
        }
        .button.warning {
            background-color: #ff9800;
        }
        .button.warning:hover {
            background-color: #e68a00;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.success {
            background-color: rgba(76, 175, 80, 0.2);
            border: 1px solid #4CAF50;
        }
        .status.error {
            background-color: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
        }
        .status.warning {
            background-color: rgba(255, 152, 0, 0.2);
            border: 1px solid #ff9800;
        }
        .status.info {
            background-color: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196F3;
        }
        pre {
            background-color: #333;
            color: #fff;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .hidden {
            display: none;
        }
        .subscription-count {
            font-size: 18px;
            margin-bottom: 10px;
        }
        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            color: #4CAF50;
            text-decoration: none;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">← Back to Home</a>
        <h1>Push Notification Subscription Manager</h1>

        <div class="card">
            <h2>Subscription Status</h2>
            <div id="subscriptionStatus" class="status info">
                Loading subscription information...
            </div>
            <div id="subscriptionCount" class="subscription-count"></div>
            <button id="refreshButton" class="button">Refresh Status</button>
        </div>

        <div class="card">
            <h2>Subscription Actions</h2>
            <p>Use these actions to manage push notification subscriptions:</p>

            <div>
                <button id="validateButton" class="button">Validate Subscriptions</button>
                <p>Sends a test notification to all subscriptions to verify they are still valid.</p>
            </div>

            <div>
                <button id="cleanButton" class="button warning">Clean Invalid Subscriptions</button>
                <p>Removes subscriptions with invalid formats or missing required keys.</p>
            </div>

            <div>
                <button id="clearAllButton" class="button danger">Clear All Subscriptions</button>
                <p>⚠️ WARNING: This will remove ALL subscriptions. Users will need to re-subscribe.</p>
            </div>

            <div>
                <button id="testButton" class="button">Send Test Notification</button>
                <p>Sends a test notification to all valid subscriptions.</p>
            </div>
        </div>

        <div class="card">
            <h2>Result</h2>
            <div id="resultStatus" class="status hidden"></div>
            <pre id="resultData" class="hidden"></pre>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const subscriptionStatus = document.getElementById('subscriptionStatus');
            const subscriptionCount = document.getElementById('subscriptionCount');
            const resultStatus = document.getElementById('resultStatus');
            const resultData = document.getElementById('resultData');
            const refreshButton = document.getElementById('refreshButton');
            const validateButton = document.getElementById('validateButton');
            const cleanButton = document.getElementById('cleanButton');
            const clearAllButton = document.getElementById('clearAllButton');
            const testButton = document.getElementById('testButton');

            // Function to refresh subscription status
            async function refreshStatus() {
                try {
                    subscriptionStatus.className = 'status info';
                    subscriptionStatus.textContent = 'Loading subscription information...';

                    // Get subscription count from API
                    const response = await fetch('/api/subscription-count');
                    const data = await response.json();

                    if (data.success) {
                        subscriptionStatus.className = 'status success';
                        subscriptionStatus.textContent = 'Connected to notification server';

                        // Update subscription count
                        const count = data.count && data.count.count !== undefined ? data.count.count : 'Unknown';
                        localStorage.setItem('subscriptionCount', count);
                        subscriptionCount.textContent = `Current subscription count: ${count}`;
                    } else {
                        throw new Error(data.message || 'Unknown error');
                    }
                } catch (error) {
                    subscriptionStatus.className = 'status error';
                    subscriptionStatus.textContent = `Error connecting to server: ${error.message}`;
                }
            }

            // Function to show result
            function showResult(success, message, data) {
                resultStatus.className = `status ${success ? 'success' : 'error'}`;
                resultStatus.textContent = message;
                resultStatus.classList.remove('hidden');

                if (data) {
                    resultData.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
                    resultData.classList.remove('hidden');
                } else {
                    resultData.classList.add('hidden');
                }

                // Update subscription count if available in the result
                if (data && data.result && (data.result.remainingCount !== undefined)) {
                    localStorage.setItem('subscriptionCount', data.result.remainingCount);
                    subscriptionCount.textContent = `Current subscription count: ${data.result.remainingCount}`;
                }
            }

            // Event listeners
            refreshButton.addEventListener('click', refreshStatus);

            validateButton.addEventListener('click', async () => {
                try {
                    validateButton.disabled = true;
                    validateButton.textContent = 'Validating...';

                    const response = await fetch('/api/validate-subscriptions', {
                        method: 'POST'
                    });
                    const data = await response.json();

                    showResult(data.success, 'Validation complete', data);
                } catch (error) {
                    showResult(false, `Error validating subscriptions: ${error.message}`);
                } finally {
                    validateButton.disabled = false;
                    validateButton.textContent = 'Validate Subscriptions';
                }
            });

            cleanButton.addEventListener('click', async () => {
                try {
                    cleanButton.disabled = true;
                    cleanButton.textContent = 'Cleaning...';

                    const response = await fetch('/api/clean-subscriptions', {
                        method: 'POST'
                    });
                    const data = await response.json();

                    showResult(data.success, 'Cleanup complete', data);
                } catch (error) {
                    showResult(false, `Error cleaning subscriptions: ${error.message}`);
                } finally {
                    cleanButton.disabled = false;
                    cleanButton.textContent = 'Clean Invalid Subscriptions';
                }
            });

            clearAllButton.addEventListener('click', async () => {
                if (!confirm('WARNING: This will remove ALL subscriptions. Users will need to re-subscribe. Continue?')) {
                    return;
                }

                try {
                    clearAllButton.disabled = true;
                    clearAllButton.textContent = 'Clearing...';

                    const response = await fetch('/api/clear-all-subscriptions', {
                        method: 'POST'
                    });
                    const data = await response.json();

                    showResult(data.success, 'All subscriptions cleared', data);
                } catch (error) {
                    showResult(false, `Error clearing subscriptions: ${error.message}`);
                } finally {
                    clearAllButton.disabled = false;
                    clearAllButton.textContent = 'Clear All Subscriptions';
                }
            });

            testButton.addEventListener('click', async () => {
                try {
                    testButton.disabled = true;
                    testButton.textContent = 'Sending...';

                    const response = await fetch('/api/notifications/test', {
                        method: 'POST'
                    });
                    const data = await response.json();

                    showResult(data.success, 'Test notification sent', data);
                } catch (error) {
                    showResult(false, `Error sending test notification: ${error.message}`);
                } finally {
                    testButton.disabled = false;
                    testButton.textContent = 'Send Test Notification';
                }
            });

            // Initial refresh
            refreshStatus();
        });
    </script>
</body>
</html>
