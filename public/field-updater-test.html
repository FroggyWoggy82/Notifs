<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Updater Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #121212;
            color: white;
            margin: 0;
            padding: 20px;
        }
        h1, h2 {
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #333;
            color: white;
        }
        button {
            background-color: #ffffff;
            color: #000000;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button:hover {
            background-color: #e0e0e0;
        }
        .status {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
        }
        .success {
            background-color: #1b5e20;
            color: white;
        }
        .error {
            background-color: #b71c1c;
            color: white;
        }
        .info {
            background-color: #0d47a1;
            color: white;
        }
        pre {
            background-color: #2d2d2d;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            color: #e0e0e0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Field Updater Test</h1>
        <p>This page tests the direct field update functionality for ingredients.</p>

        <div class="form-group">
            <label for="recipe-id">Recipe ID:</label>
            <input type="number" id="recipe-id" placeholder="Enter recipe ID">
        </div>

        <div class="form-group">
            <label for="ingredient-id">Ingredient ID:</label>
            <input type="number" id="ingredient-id" placeholder="Enter ingredient ID">
        </div>

        <div class="form-group">
            <label for="field-name">Field Name:</label>
            <select id="field-name">
                <option value="name">Name</option>
                <option value="calories">Calories</option>
                <option value="amount">Amount</option>
                <option value="protein">Protein</option>
                <option value="fats">Fats</option>
                <option value="carbohydrates">Carbohydrates</option>
                <option value="price">Price</option>
                <option value="package_amount">Package Amount</option>
                <option value="alcohol">Alcohol</option>
                <option value="caffeine">Caffeine</option>
                <option value="water">Water</option>
                <option value="fiber">Fiber</option>
                <option value="starch">Starch</option>
                <option value="sugars">Sugars</option>
                <option value="added_sugars">Added Sugars</option>
                <option value="net_carbs">Net Carbs</option>
                <option value="saturated">Saturated</option>
                <option value="monounsaturated">Monounsaturated</option>
                <option value="polyunsaturated">Polyunsaturated</option>
                <option value="omega_3">Omega 3</option>
                <option value="omega_6">Omega 6</option>
                <option value="trans_fat">Trans Fat</option>
                <option value="cholesterol">Cholesterol</option>
                <option value="cystine">Cystine</option>
                <option value="histidine">Histidine</option>
                <option value="isoleucine">Isoleucine</option>
                <option value="leucine">Leucine</option>
                <option value="lysine">Lysine</option>
                <option value="methionine">Methionine</option>
                <option value="phenylalanine">Phenylalanine</option>
                <option value="threonine">Threonine</option>
                <option value="tryptophan">Tryptophan</option>
                <option value="tyrosine">Tyrosine</option>
                <option value="valine">Valine</option>
                <option value="thiamine">Thiamine (B1)</option>
                <option value="riboflavin">Riboflavin (B2)</option>
                <option value="niacin">Niacin (B3)</option>
                <option value="pantothenic_acid">Pantothenic Acid (B5)</option>
                <option value="vitamin_b6">Vitamin B6</option>
                <option value="vitamin_b12">Vitamin B12</option>
                <option value="folate">Folate</option>
                <option value="vitamin_a">Vitamin A</option>
                <option value="vitamin_c">Vitamin C</option>
                <option value="vitamin_d">Vitamin D</option>
                <option value="vitamin_e">Vitamin E</option>
                <option value="vitamin_k">Vitamin K</option>
                <option value="calcium">Calcium</option>
                <option value="copper">Copper</option>
                <option value="iron">Iron</option>
                <option value="magnesium">Magnesium</option>
                <option value="manganese">Manganese</option>
                <option value="phosphorus">Phosphorus</option>
                <option value="potassium">Potassium</option>
                <option value="selenium">Selenium</option>
                <option value="sodium">Sodium</option>
                <option value="zinc">Zinc</option>
            </select>
        </div>

        <div class="form-group">
            <label for="field-value">Field Value:</label>
            <input type="text" id="field-value" placeholder="Enter field value">
        </div>

        <button id="update-button">Update Field</button>

        <h3>Update Omega Values</h3>
        <div class="form-group">
            <label for="omega3-value">Omega 3 Value:</label>
            <input type="text" id="omega3-value" placeholder="Enter omega 3 value">
        </div>

        <div class="form-group">
            <label for="omega6-value">Omega 6 Value:</label>
            <input type="text" id="omega6-value" placeholder="Enter omega 6 value">
        </div>

        <button id="update-omega-button">Update Omega Values</button>

        <div id="status" class="status"></div>

        <h2>Response:</h2>
        <pre id="response-output"></pre>
    </div>

    <script src="js/field-updater.js"></script>
    <script src="js/food/omega-storage.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const updateButton = document.getElementById('update-button');
            const updateOmegaButton = document.getElementById('update-omega-button');
            const recipeIdInput = document.getElementById('recipe-id');
            const ingredientIdInput = document.getElementById('ingredient-id');
            const fieldNameSelect = document.getElementById('field-name');
            const fieldValueInput = document.getElementById('field-value');
            const omega3ValueInput = document.getElementById('omega3-value');
            const omega6ValueInput = document.getElementById('omega6-value');
            const statusDiv = document.getElementById('status');
            const responseOutput = document.getElementById('response-output');

            // Check if field updater is available
            if (!window.fieldUpdater) {
                showStatus('Field updater not available. Please check if field-updater.js is loaded correctly.', 'error');
                updateButton.disabled = true;
                updateOmegaButton.disabled = true;
                return;
            }

            updateButton.addEventListener('click', async function() {
                const recipeId = recipeIdInput.value.trim();
                const ingredientId = ingredientIdInput.value.trim();
                const fieldName = fieldNameSelect.value;
                const fieldValue = fieldValueInput.value.trim();

                if (!recipeId) {
                    showStatus('Please enter a recipe ID.', 'error');
                    return;
                }

                if (!ingredientId) {
                    showStatus('Please enter an ingredient ID.', 'error');
                    return;
                }

                if (!fieldName) {
                    showStatus('Please select a field name.', 'error');
                    return;
                }

                showStatus('Updating field...', 'info');

                try {
                    const result = await window.fieldUpdater.updateField(recipeId, ingredientId, fieldName, fieldValue);

                    if (result.success) {
                        showStatus('Field updated successfully!', 'success');
                    } else {
                        showStatus(`Error updating field: ${result.error || 'Unknown error'}`, 'error');
                    }

                    responseOutput.textContent = JSON.stringify(result, null, 2);
                } catch (error) {
                    showStatus(`Error: ${error.message}`, 'error');
                    responseOutput.textContent = JSON.stringify({ error: error.message }, null, 2);
                }
            });

            // Add event listener for the update omega values button
            updateOmegaButton.addEventListener('click', async function() {
                const recipeId = recipeIdInput.value.trim();
                const ingredientId = ingredientIdInput.value.trim();
                const omega3Value = omega3ValueInput.value.trim();
                const omega6Value = omega6ValueInput.value.trim();

                if (!recipeId) {
                    showStatus('Please enter a recipe ID.', 'error');
                    return;
                }

                if (!ingredientId) {
                    showStatus('Please enter an ingredient ID.', 'error');
                    return;
                }

                if (!omega3Value && !omega6Value) {
                    showStatus('Please enter at least one omega value.', 'error');
                    return;
                }

                showStatus('Saving omega values to OmegaStorage...', 'info');

                try {
                    // Convert values to numbers
                    const omega3 = omega3Value ? Number(omega3Value) : undefined;
                    const omega6 = omega6Value ? Number(omega6Value) : undefined;

                    // Save to OmegaStorage
                    if (window.OmegaStorage) {
                        const saveResult = window.OmegaStorage.saveOmegaValues(
                            ingredientId,
                            omega3,
                            omega6
                        );

                        if (saveResult) {
                            showStatus('Omega values saved successfully to OmegaStorage!', 'success');

                            const result = {
                                success: true,
                                message: 'Omega values saved successfully to OmegaStorage',
                                // CRITICAL FIX: Use omega3 and omega6 (without underscores) to match database column names
                                omega3: omega3,
                                omega6: omega6,
                                timestamp: Date.now()
                            };

                            responseOutput.textContent = JSON.stringify(result, null, 2);

                            // Verify the values in OmegaStorage
                            const storedValues = window.OmegaStorage.loadOmegaValues(ingredientId);
                            if (storedValues) {
                                responseOutput.textContent += '\n\nVerification from OmegaStorage:\n' + JSON.stringify(storedValues, null, 2);
                            } else {
                                responseOutput.textContent += '\n\nVerification from OmegaStorage: No values found';
                            }
                        } else {
                            showStatus('Failed to save omega values to OmegaStorage', 'error');
                            responseOutput.textContent = JSON.stringify({
                                success: false,
                                error: 'Failed to save omega values to OmegaStorage'
                            }, null, 2);
                        }
                    } else {
                        showStatus('OmegaStorage not available', 'error');
                        responseOutput.textContent = JSON.stringify({
                            success: false,
                            error: 'OmegaStorage not available'
                        }, null, 2);
                    }

                    // Try to fetch the ingredient from the server for comparison
                    try {
                        const fetchFunction = window.safeFetch || fetch;
                        const verifyResponse = await fetchFunction(`/api/recipes/${recipeId}/ingredients/${ingredientId}`);

                        if (verifyResponse.ok) {
                            const ingredient = await verifyResponse.json();
                            const verifyResult = {
                                message: 'Server data (for comparison only)',
                                omega_3: ingredient.omega_3,
                                omega_6: ingredient.omega_6
                            };

                            responseOutput.textContent += '\n\nServer data (for comparison only):\n' + JSON.stringify(verifyResult, null, 2);
                        }
                    } catch (verifyError) {
                        console.error('Error fetching server data:', verifyError);
                    }
                } catch (error) {
                    showStatus(`Error: ${error.message}`, 'error');
                    responseOutput.textContent = JSON.stringify({ error: error.message }, null, 2);
                }
            });

            function showStatus(message, type) {
                statusDiv.textContent = message;
                statusDiv.className = 'status ' + (type || 'info');
            }
        });
    </script>
</body>
</html>
