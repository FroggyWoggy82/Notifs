/**
 * Fix Recipe Ingredient API
 * 
 * This script provides a direct API call to the recipe-ingredients endpoint
 * to ensure ingredients are properly added to recipes.
 */

(function() {
    console.log('[Recipe Ingredient API Fix] Initializing...');
    
    // Create a function to add an ingredient to a recipe using the dedicated endpoint
    window.addIngredientToRecipe = async function(recipeId, ingredientData) {
        console.log(`[Recipe Ingredient API Fix] Adding ingredient to recipe ${recipeId}`);
        
        // Ensure all numeric fields are numbers, not strings
        const numericFields = [
            'amount', 'package_amount', 'price', 'calories', 'protein', 'fats', 'carbohydrates',
            'fiber', 'starch', 'sugars', 'added_sugars', 'net_carbs', 'monounsaturated',
            'polyunsaturated', 'omega3', 'omega6', 'saturated', 'trans', 'cholesterol',
            'alcohol', 'caffeine', 'water', 'thiamine', 'riboflavin', 'niacin', 'pantothenic_acid',
            'vitamin_b6', 'vitamin_b12', 'folate', 'vitamin_a', 'vitamin_c', 'vitamin_d',
            'vitamin_e', 'vitamin_k', 'calcium', 'copper', 'iron', 'magnesium', 'manganese',
            'phosphorus', 'potassium', 'selenium', 'sodium', 'zinc', 'cystine', 'histidine',
            'isoleucine', 'leucine', 'lysine', 'methionine', 'phenylalanine', 'threonine',
            'tryptophan', 'tyrosine', 'valine'
        ];
        
        // Create a copy of the ingredient data to avoid modifying the original
        const processedData = { ...ingredientData };
        
        // Convert string values to numbers for numeric fields
        numericFields.forEach(field => {
            if (processedData[field] !== undefined && processedData[field] !== null) {
                if (typeof processedData[field] === 'string') {
                    processedData[field] = parseFloat(processedData[field]);
                    if (isNaN(processedData[field])) {
                        processedData[field] = 0;
                    }
                }
            }
        });
        
        // Extract the required fields for the API
        const requiredData = {
            name: processedData.name || processedData['add-ingredient-name'],
            amount: processedData.amount || processedData['add-ingredient-amount'],
            package_amount: processedData.package_amount || processedData['add-ingredient-package-amount'],
            price: processedData.price || processedData['add-ingredient-price'],
            calories: processedData.calories || processedData['add-ingredient-calories'] || processedData['ingredient-calories'],
            protein: processedData.protein || processedData['add-ingredient-protein'] || processedData['ingredient-protein'],
            fats: processedData.fats || processedData['add-ingredient-fats'] || processedData['ingredient-fat'],
            carbohydrates: processedData.carbohydrates || processedData['add-ingredient-carbs'] || processedData['ingredient-carbs']
        };
        
        // Add micronutrient data if available
        numericFields.forEach(field => {
            // Skip fields already added
            if (['amount', 'package_amount', 'price', 'calories', 'protein', 'fats', 'carbohydrates'].includes(field)) {
                return;
            }
            
            // Check all possible field name variations
            const value = processedData[field] || 
                          processedData[`add-ingredient-${field}`] || 
                          processedData[`ingredient-${field}`];
            
            if (value !== undefined && value !== null) {
                requiredData[field] = parseFloat(value);
            }
        });
        
        console.log('[Recipe Ingredient API Fix] Processed data for API:', requiredData);
        
        // Use the dedicated recipe-ingredients endpoint
        try {
            console.log('[Recipe Ingredient API Fix] Using recipe-ingredients endpoint...');
            const response = await fetch(`/api/recipe-ingredients/${recipeId}/ingredients`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Cache-Control': 'no-cache, no-store, must-revalidate'
                },
                body: JSON.stringify(requiredData)
            });
            
            console.log(`[Recipe Ingredient API Fix] Response status: ${response.status}`);
            
            if (response.ok) {
                console.log('[Recipe Ingredient API Fix] Ingredient added successfully');
                return response;
            } else {
                console.error('[Recipe Ingredient API Fix] Error adding ingredient:', response.status);
                
                // Try to get more details about the error
                try {
                    const errorData = await response.json();
                    console.error('[Recipe Ingredient API Fix] Error details:', errorData);
                } catch (e) {
                    // Ignore JSON parsing errors
                }
                
                return response;
            }
        } catch (error) {
            console.error('[Recipe Ingredient API Fix] API call failed:', error);
            throw error;
        }
    };
    
    // Override the add ingredient form submission
    document.addEventListener('DOMContentLoaded', function() {
        console.log('[Recipe Ingredient API Fix] Setting up form submission override');
        
        // Find all add ingredient forms
        const forms = document.querySelectorAll('form#add-ingredient-form');
        
        forms.forEach(form => {
            console.log('[Recipe Ingredient API Fix] Found add ingredient form:', form);
            
            form.addEventListener('submit', async function(event) {
                console.log('[Recipe Ingredient API Fix] Form submission intercepted');
                event.preventDefault();
                
                // Get the recipe ID
                const recipeIdInput = form.querySelector('#add-ingredient-recipe-id');
                if (!recipeIdInput || !recipeIdInput.value) {
                    console.error('[Recipe Ingredient API Fix] Recipe ID not found');
                    return;
                }
                
                const recipeId = recipeIdInput.value;
                console.log(`[Recipe Ingredient API Fix] Recipe ID: ${recipeId}`);
                
                // Collect all form data
                const formData = new FormData(form);
                const ingredientData = {};
                
                // Process form data and extract hidden fields
                for (const [key, value] of formData.entries()) {
                    ingredientData[key] = value;
                }
                
                // Get micronutrient data from hidden fields
                const hiddenFields = form.querySelectorAll('input[type="hidden"]');
                hiddenFields.forEach(field => {
                    if (field.name && field.value) {
                        ingredientData[field.name] = field.value;
                    }
                });
                
                // Check if we have complete nutrition data stored in the form
                if (form.dataset.completeNutritionData) {
                    try {
                        const nutritionData = JSON.parse(form.dataset.completeNutritionData);
                        console.log('[Recipe Ingredient API Fix] Found complete nutrition data');
                        
                        // Add all nutrition data to the ingredient data
                        Object.entries(nutritionData).forEach(([key, value]) => {
                            if (key !== 'success') {
                                ingredientData[key] = value;
                            }
                        });
                    } catch (error) {
                        console.error('[Recipe Ingredient API Fix] Error parsing complete nutrition data:', error);
                    }
                }
                
                // Check if we have DB format nutrition data stored in the form
                if (form.dataset.dbFormatNutritionData) {
                    try {
                        const dbFormatData = JSON.parse(form.dataset.dbFormatNutritionData);
                        console.log('[Recipe Ingredient API Fix] Found DB format nutrition data');
                        
                        // Add all DB format nutrition data to the ingredient data
                        Object.entries(dbFormatData).forEach(([key, value]) => {
                            ingredientData[key] = value;
                        });
                    } catch (error) {
                        console.error('[Recipe Ingredient API Fix] Error parsing DB format nutrition data:', error);
                    }
                }
                
                // Add the ingredient directly
                try {
                    const response = await window.addIngredientToRecipe(recipeId, ingredientData);
                    
                    if (response.ok) {
                        console.log('[Recipe Ingredient API Fix] Ingredient added successfully');
                        
                        // Hide the form
                        form.style.display = 'none';
                        
                        // Refresh the ingredient list
                        const recipeCard = document.querySelector(`.recipe-card[data-id="${recipeId}"]`);
                        if (recipeCard) {
                            const detailsDiv = recipeCard.querySelector('.ingredient-details');
                            if (detailsDiv && typeof window.fetchAndDisplayIngredients === 'function') {
                                console.log('[Recipe Ingredient API Fix] Refreshing ingredient list');
                                window.fetchAndDisplayIngredients(recipeId, detailsDiv, null, true);
                            }
                        }
                    } else {
                        console.error('[Recipe Ingredient API Fix] Failed to add ingredient:', response.status);
                    }
                } catch (error) {
                    console.error('[Recipe Ingredient API Fix] Error adding ingredient:', error);
                }
            });
        });
    });
    
    console.log('[Recipe Ingredient API Fix] Initialized');
})();
