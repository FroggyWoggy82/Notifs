/**
 * Fix Recipe API Endpoints
 *
 * This script is now a lightweight wrapper that defers to the consolidated
 * recipe ingredient fix for handling recipe API endpoints.
 */

(function() {
    console.log('[Recipe API Endpoints Fix] Initializing...');

    // Check if the consolidated fix is loaded
    if (typeof window.addIngredientToRecipe === 'function') {
        console.log('[Recipe API Endpoints Fix] Consolidated fix detected, deferring to it');
        // No need to do anything, the consolidated fix will handle everything
    } else {
        console.log('[Recipe API Endpoints Fix] Consolidated fix not detected, this script is now deprecated');
        // The consolidated fix should be used instead of this script

        // Store the original fetch function
        const originalFetch = window.fetch;

        // Override the fetch function
        window.fetch = function(url, options) {
            // Check if this is a recipe API call for getting a single ingredient
            if (typeof url === 'string' &&
                url.match(/\/api\/recipes\/\d+\/ingredients\/\d+$/) &&
                options && options.method === 'GET') {

                console.log('[Recipe API Endpoints Fix] Detected get ingredient from recipe request');

                // Extract the recipe ID and ingredient ID from the URL
                const matches = url.match(/\/api\/recipes\/(\d+)\/ingredients\/(\d+)/);
                const recipeId = matches[1];
                const ingredientId = matches[2];

                // Create a new URL for the correct endpoint
                const newUrl = `/api/recipes/${recipeId}`;
                console.log(`[Recipe API Endpoints Fix] Redirecting to: ${newUrl}`);

                // Return the fetch with the new URL
                return originalFetch(newUrl, options)
                    .then(response => {
                        console.log(`[Recipe API Endpoints Fix] Response status: ${response.status}`);

                        // Clone the response to avoid modifying the original
                        return response.clone().json()
                            .then(data => {
                                console.log('[Recipe API Endpoints Fix] Response data:', data);

                                // Find the ingredient with the matching ID
                                const ingredient = data.ingredients.find(ing => ing.id == ingredientId);

                                if (!ingredient) {
                                    // If the ingredient is not found, return a 404 response
                                    return new Response(JSON.stringify({
                                        error: 'Ingredient not found'
                                    }), {
                                        status: 404,
                                        headers: {
                                            'Content-Type': 'application/json'
                                        }
                                    });
                                }

                                // Create a new response with just the ingredient data
                                const newResponse = new Response(JSON.stringify(ingredient), {
                                    status: 200,
                                    headers: {
                                        'Content-Type': 'application/json'
                                    }
                                });

                                return newResponse;
                            })
                            .catch(() => {
                                // If we can't parse the response as JSON, return the original response
                                return response;
                            });
                    });
            }

            // For all other requests, use the original fetch
            return originalFetch.apply(this, arguments);
        };
    }

    console.log('[Recipe API Endpoints Fix] Initialized');
})();
