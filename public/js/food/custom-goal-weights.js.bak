// Global variables
let customGoalWeights = [];
let selectedWeeks = [];
let weeklyIncrementDates = [];
let isEditMode = false;

// Initialize the custom goal weights UI
function initCustomGoalWeights() {
    // Add event listeners
    document.getElementById('edit-goal-weights-btn').addEventListener('click', toggleEditMode);
    document.getElementById('save-custom-weights-btn').addEventListener('click', saveCustomWeights);
    document.getElementById('cancel-custom-weights-btn').addEventListener('click', cancelCustomWeights);
    document.getElementById('reset-custom-weights-btn').addEventListener('click', resetCustomWeights);

    // Add debug button event listener if it exists
    const debugBtn = document.getElementById('debug-points-btn');
    if (debugBtn) {
        debugBtn.addEventListener('click', debugPoints);
    }

    // Initialize the selected weeks container
    const selectedWeeksContainer = document.getElementById('selected-weeks');
    if (!selectedWeeksContainer) {
        // Create the selected weeks container
        const container = document.createElement('p');
        container.id = 'selected-weeks';
        container.innerHTML = '<em style="color: #aaa;">No weeks selected</em>';
        container.style.backgroundColor = 'transparent';
        container.style.padding = '5px';
        container.style.border = 'none';
        container.style.display = 'block';
        container.style.color = 'white';
        container.style.fontWeight = 'normal';
        container.style.marginTop = '10px';
        container.style.marginBottom = '10px';

        // Find the custom weights panel
        const customWeightsPanel = document.getElementById('custom-weights-panel');
        if (customWeightsPanel) {
            // Insert after the instructions paragraph
            const instructionsParagraph = customWeightsPanel.querySelector('#point-selection-instructions');
            if (instructionsParagraph) {
                instructionsParagraph.parentNode.insertBefore(container, instructionsParagraph.nextSibling);
            } else {
                // Just append to the panel
                customWeightsPanel.appendChild(container);
            }
        } else {
            // Just add it to the body
            document.body.appendChild(container);
        }
    }

    // Initialize the weight input container
    createWeightInputContainer();

    // Load custom goal weights from the server
    loadCustomGoalWeights();
}

// Debug function to help identify points
function debugPoints() {
    console.log('Debugging chart points...');

    // Get the chart instance
    if (!window.weightGoalChart) {
        console.error('Weight goal chart instance not found');
        alert('Chart not fully initialized. Please try refreshing the page.');
        return;
    }

    // Get the chart canvas
    const canvas = document.getElementById('weight-goal-chart');
    if (!canvas) {
        console.error('Weight goal chart canvas not found');
        return;
    }

    // Log information about the chart
    console.log('Chart instance:', window.weightGoalChart);
    console.log('Chart data:', window.weightGoalChart.data);
    console.log('Chart options:', window.weightGoalChart.options);

    // Log information about the datasets
    if (window.weightGoalChart.data && window.weightGoalChart.data.datasets) {
        console.log('Datasets:', window.weightGoalChart.data.datasets);

        // Log information about each dataset
        window.weightGoalChart.data.datasets.forEach((dataset, datasetIndex) => {
            console.log(`Dataset ${datasetIndex} (${dataset.label}):`, dataset);
            console.log(`Dataset ${datasetIndex} data:`, dataset.data);
        });
    }

    // Log information about the weekly goal weights
    if (window.weeklyGoalWeights && window.weeklyGoalWeights.length > 0) {
        console.log('Weekly goal weights:', window.weeklyGoalWeights);

        // Log information about each weekly goal weight
        window.weeklyGoalWeights.forEach((weeklyPoint, index) => {
            console.log(`Weekly goal weight ${index}:`, weeklyPoint);
        });
    }

    // Highlight the goal weight points by making them larger and adding labels
    if (window.weightGoalChart && window.weightGoalChart.data && window.weightGoalChart.data.datasets.length > 1) {
        const goalDataset = window.weightGoalChart.data.datasets[1];

        // Make all points visible for debugging
        goalDataset.pointRadius = function(context) {
            return 8; // Make all points visible with 8px radius
        };

        // Add different colors to help identify points
        goalDataset.pointBackgroundColor = function(context) {
            // Check if this is a weekly increment point
            if (window.weeklyGoalWeights && window.weeklyGoalWeights.length > 0) {
                const weeklyPoint = window.weeklyGoalWeights.find(w => w.index === context.dataIndex);

                if (weeklyPoint) {
                    // Use a different color for each week
                    const colors = ['#ff6384', '#36a2eb', '#ffce56', '#4bc0c0', '#9966ff', '#ff9f40', '#c9cbcf'];
                    return colors[weeklyPoint.week % colors.length];
                }
            }

            return '#ff6384'; // Default red for other points
        };

        // Add white borders to all points
        goalDataset.pointBorderColor = '#ffffff';
        goalDataset.pointBorderWidth = 2;

        // Make hover radius larger
        goalDataset.pointHoverRadius = 12;

        // Update the chart
        window.weightGoalChart.update();

        // Add labels to the points
        const chartContainer = canvas.parentElement;
        const debugLabels = document.createElement('div');
        debugLabels.id = 'debug-labels';
        debugLabels.style.position = 'absolute';
        debugLabels.style.top = '0';
        debugLabels.style.left = '0';
        debugLabels.style.width = '100%';
        debugLabels.style.height = '100%';
        debugLabels.style.pointerEvents = 'none';
        debugLabels.style.zIndex = '1000';

        // Remove any existing debug labels
        const existingLabels = document.getElementById('debug-labels');
        if (existingLabels) {
            existingLabels.remove();
        }

        chartContainer.appendChild(debugLabels);

        // Add a label for each weekly goal weight
        if (window.weeklyGoalWeights && window.weeklyGoalWeights.length > 0) {
            window.weeklyGoalWeights.forEach(weeklyPoint => {
                // Get the position of the point on the canvas
                const meta = window.weightGoalChart.getDatasetMeta(1);
                if (meta && meta.data && meta.data[weeklyPoint.index]) {
                    const point = meta.data[weeklyPoint.index];

                    // Create a label element
                    const label = document.createElement('div');
                    label.style.position = 'absolute';
                    label.style.left = `${point.x}px`;
                    label.style.top = `${point.y - 20}px`;
                    label.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                    label.style.color = 'white';
                    label.style.padding = '2px 5px';
                    label.style.borderRadius = '3px';
                    label.style.fontSize = '12px';
                    label.style.transform = 'translate(-50%, -100%)';
                    label.textContent = `Week ${weeklyPoint.week}`;

                    debugLabels.appendChild(label);
                }
            });
        }
    }

    // Alert with instructions
    alert('Debug information has been logged to the console. Points have been highlighted with labels.');

    // Reset after 10 seconds
    setTimeout(() => {
        // Remove the debug labels
        const debugLabels = document.getElementById('debug-labels');
        if (debugLabels) {
            debugLabels.remove();
        }

        // Reset the chart points to their original appearance
        if (window.weightGoalChart && window.weightGoalChart.data && window.weightGoalChart.data.datasets.length > 1) {
            const goalDataset = window.weightGoalChart.data.datasets[1];

            // Reset point radius
            goalDataset.pointRadius = function(context) {
                // Check if this is a weekly increment point
                if (window.weeklyGoalWeights && window.weeklyGoalWeights.length > 0) {
                    const isWeeklyPoint = window.weeklyGoalWeights.some(w => w.index === context.dataIndex);
                    return isWeeklyPoint ? 3 : 0; // 3px radius for weekly points, 0 for others
                }
                return 0;
            };

            // Reset point background color
            goalDataset.pointBackgroundColor = function(context) {
                // Check if this is a weekly increment point
                if (window.weeklyGoalWeights && window.weeklyGoalWeights.length > 0) {
                    const isWeeklyPoint = window.weeklyGoalWeights.some(w => w.index === context.dataIndex);
                    return isWeeklyPoint ? '#e74c3c' : 'transparent'; // Red for weekly points
                }
                return 'transparent';
            };

            // Reset point border color
            goalDataset.pointBorderColor = function(context) {
                // Check if this is a weekly increment point
                if (window.weeklyGoalWeights && window.weeklyGoalWeights.length > 0) {
                    const isWeeklyPoint = window.weeklyGoalWeights.some(w => w.index === context.dataIndex);
                    return isWeeklyPoint ? '#fff' : 'transparent'; // White border for weekly points
                }
                return 'transparent';
            };

            // Reset point border width
            goalDataset.pointBorderWidth = 1;

            // Reset point hover radius
            goalDataset.pointHoverRadius = 5;

            // Update the chart
            window.weightGoalChart.update();
        }
    }, 10000);
}

// Toggle edit mode for custom goal weights
function toggleEditMode() {
    isEditMode = !isEditMode;
    console.log(`Toggle edit mode: ${isEditMode ? 'ON' : 'OFF'}`);

    // Update UI based on edit mode
    const customWeightsPanel = document.getElementById('custom-weights-panel');
    const editBtn = document.getElementById('edit-goal-weights-btn');
    const actionBtns = document.getElementById('custom-weights-actions');

    if (isEditMode) {
        customWeightsPanel.classList.add('edit-mode');
        editBtn.textContent = 'Cancel';
        actionBtns.style.display = 'flex';

        // Make sure the chart is initialized
        if (!window.weightGoalChart) {
            console.log('Chart not initialized, trying to find it...');

            // Try to get the chart from the Chart.js registry
            if (window.Chart && window.Chart.instances) {
                const chartInstances = Object.values(window.Chart.instances);
                if (chartInstances.length > 0) {
                    // Use the first chart instance found
                    window.weightGoalChart = chartInstances[0];
                    console.log('Found chart instance:', window.weightGoalChart);
                }
            }

            if (!window.weightGoalChart) {
                console.error('Could not find chart instance');
                alert('Chart not initialized. Please try refreshing the page.');
                return;
            }
        }

        // Show a notification to the user
        alert('Click on the red dots (goal weight points) on the chart to select them for adjustment. You can select multiple points.');

        // Enable selection of points
        enablePointSelection();

        // Scroll to make sure the chart is visible
        document.getElementById('weight-goal-chart').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });
    } else {
        customWeightsPanel.classList.remove('edit-mode');
        editBtn.textContent = 'Edit Goal Weights';
        actionBtns.style.display = 'none';

        // Disable selection of points
        disablePointSelection();

        // Clear selected weeks
        selectedWeeks = [];
        updateSelectedWeeksUI();
    }
}

// Enable selection of points on the chart
function enablePointSelection() {
    console.log('Enabling point selection...');

    // Wait a moment for the chart to fully render
    setTimeout(() => {
        // Get the chart instance
        if (!window.weightGoalChart) {
            console.error('Weight goal chart instance not found');

            // Try to get the chart from the Chart.js registry
            if (window.Chart && window.Chart.instances) {
                const chartInstances = Object.values(window.Chart.instances);
                if (chartInstances.length > 0) {
                    // Use the first chart instance found
                    window.weightGoalChart = chartInstances[0];
                    console.log('Found chart instance:', window.weightGoalChart);
                }
            }

            if (!window.weightGoalChart) {
                alert('Chart not fully initialized. Please try refreshing the page.');
                return;
            }
        }

        // Since we're using a Canvas-based chart, we need to add click handlers to the canvas
        const canvas = document.getElementById('weight-goal-chart');
        if (!canvas) {
            console.error('Weight goal chart canvas not found');
            return;
        }

        const chartContainer = canvas.parentElement;
        chartContainer.classList.add('goal-edit-mode');

        // Show instructions
        const instructionsElement = document.getElementById('point-selection-instructions');
        if (instructionsElement) {
            instructionsElement.style.display = 'block';
        }

        // Add a click handler to the canvas
        canvas.removeEventListener('click', handleCanvasClick);
        canvas.addEventListener('click', handleCanvasClick);
        console.log('Added click handler to canvas');

        // Add a visual indicator to show we're in edit mode
        const editModeIndicator = document.createElement('div');
        editModeIndicator.id = 'edit-mode-indicator';
        editModeIndicator.className = 'edit-mode-indicator';
        editModeIndicator.textContent = 'Click on red dots to select';

        // Remove any existing indicator
        const existingIndicator = document.getElementById('edit-mode-indicator');
        if (existingIndicator) {
            existingIndicator.remove();
        }

        chartContainer.appendChild(editModeIndicator);

        // Add a style to make the goal weight points more visible
        const style = document.createElement('style');
        style.id = 'point-pulse-animation';
        style.textContent = `
            .edit-mode-indicator {
                position: absolute;
                top: 10px;
                right: 10px;
                background-color: rgba(255, 99, 132, 0.8);
                color: white;
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 14px;
                z-index: 1000;
                animation: fadeInOut 2s infinite;
            }

            @keyframes fadeInOut {
                0% { opacity: 0.7; }
                50% { opacity: 1; }
                100% { opacity: 0.7; }
            }

            /* Make the canvas cursor a pointer */
            #weight-goal-chart {
                cursor: pointer !important;
            }
        `;
        document.head.appendChild(style);

        try {
            // Highlight the goal weight points by redrawing them larger
            if (window.weightGoalChart && window.weightGoalChart.data && window.weightGoalChart.data.datasets.length > 1) {
                const goalDataset = window.weightGoalChart.data.datasets[1];

                console.log('Goal dataset before update:', goalDataset);

                // Find the future dates (goal weight points)
                const today = new Date();
                const labels = window.weightGoalChart.data.labels;
                const futureIndices = [];

                if (labels) {
                    labels.forEach((label, index) => {
                        const date = new Date(label);
                        if (date >= today) {
                            futureIndices.push(index);
                            console.log(`Found future date at index ${index}: ${label}`);
                        }
                    });
                }

                // Make the goal weight points larger and more visible
                goalDataset.pointRadius = function(context) {
                    const index = context.dataIndex;
                    // Check if this is a future date (goal weight point)
                    if (futureIndices.includes(index)) {
                        return 10; // Make future points larger
                    }
                    return 3; // Keep past points small
                };

                // Make the goal weight points red
                goalDataset.pointBackgroundColor = function(context) {
                    const index = context.dataIndex;
                    // Check if this is a future date (goal weight point)
                    if (futureIndices.includes(index)) {
                        return '#ff6384'; // Red for future points
                    }
                    return '#36a2eb'; // Blue for past points
                };

                // Add a white border to the goal weight points
                goalDataset.pointBorderColor = function(context) {
                    const index = context.dataIndex;
                    // Check if this is a future date (goal weight point)
                    if (futureIndices.includes(index)) {
                        return '#ffffff'; // White border for future points
                    }
                    return '#ffffff'; // White border for past points
                };

                // Make the border thicker
                goalDataset.pointBorderWidth = function(context) {
                    const index = context.dataIndex;
                    // Check if this is a future date (goal weight point)
                    if (futureIndices.includes(index)) {
                        return 2; // Thicker border for future points
                    }
                    return 1; // Normal border for past points
                };

                // Make the hover radius larger
                goalDataset.pointHoverRadius = function(context) {
                    const index = context.dataIndex;
                    // Check if this is a future date (goal weight point)
                    if (futureIndices.includes(index)) {
                        return 15; // Larger hover radius for future points
                    }
                    return 5; // Normal hover radius for past points
                };

                // Update the chart
                window.weightGoalChart.update();
                console.log('Chart updated with larger points');

                // Add a direct click handler to the chart area
                chartContainer.addEventListener('click', function(event) {
                    console.log('Chart container clicked');
                    handleCanvasClick(event);
                });

                // Store the future points data for direct chart clicking
                try {
                    // Find all future date points and store their data
                    const meta = window.weightGoalChart.getDatasetMeta(1);

                    if (meta && meta.data) {
                        // Store the weekly goal weights for later use
                        if (!window.weeklyGoalWeights) {
                            window.weeklyGoalWeights = [];
                        }

                        futureIndices.forEach((index, weekNumber) => {
                            if (meta.data[index]) {
                                // Check if this week already exists
                                const existingWeek = window.weeklyGoalWeights.find(w => w.week === weekNumber);
                                if (!existingWeek) {
                                    window.weeklyGoalWeights.push({
                                        week: weekNumber,
                                        index: index,
                                        date: labels[index],
                                        weight: goalDataset.data[index].y
                                    });
                                    console.log(`Added week ${weekNumber} to weekly goal weights: index ${index}, date ${labels[index]}, weight ${goalDataset.data[index].y}`);
                                }
                            }
                        });
                    }

                    // Make the chart points much larger and more visible
                    goalDataset.pointRadius = function(context) {
                        const index = context.dataIndex;
                        // Check if this is a future date (goal weight point)
                        if (futureIndices.includes(index)) {
                            return 15; // Make future points much larger
                        }
                        return 3; // Keep past points small
                    };

                    // Make the hover radius even larger
                    goalDataset.pointHoverRadius = function(context) {
                        const index = context.dataIndex;
                        // Check if this is a future date (goal weight point)
                        if (futureIndices.includes(index)) {
                            return 20; // Larger hover radius for future points
                        }
                        return 5; // Normal hover radius for past points
                    };

                    // Update the chart
                    window.weightGoalChart.update();

                } catch (error) {
                    console.error('Error setting up chart points:', error);
                }
            } else {
                console.error('Goal dataset not found or chart not properly initialized');
            }
        } catch (error) {
            console.error('Error updating chart points:', error);
        }

        // Show an alert to guide the user
        alert('Click on the red dots (goal weight points) to select them for adjustment. You can select multiple points.');
    }, 1000);
}

// Disable selection of points on the chart
function disablePointSelection() {
    console.log('Disabling point selection...');

    // Get the chart container
    const canvas = document.getElementById('weight-goal-chart');
    if (!canvas) {
        console.error('Weight goal chart canvas not found');
        return;
    }

    const chartContainer = canvas.parentElement;

    // Remove the edit mode class
    chartContainer.classList.remove('goal-edit-mode');

    // Remove the click handler from the canvas
    canvas.removeEventListener('click', handleCanvasClick);

    // Remove the edit mode indicator
    const editModeIndicator = document.getElementById('edit-mode-indicator');
    if (editModeIndicator) {
        editModeIndicator.remove();
    }

    // Remove the helper overlay with clickable markers
    const helperOverlay = document.getElementById('helper-overlay');
    if (helperOverlay) {
        helperOverlay.remove();
    }

    // Remove the week indicators container at the top
    const weekIndicatorsContainer = document.querySelector('.week-indicators-container');
    if (weekIndicatorsContainer) {
        weekIndicatorsContainer.remove();
    }

    // Remove the pulsing animation style
    const animationStyle = document.getElementById('point-pulse-animation');
    if (animationStyle) {
        animationStyle.remove();
    }

    // Reset the chart points to their original appearance
    if (window.weightGoalChart && window.weightGoalChart.data && window.weightGoalChart.data.datasets.length > 1) {
        const goalDataset = window.weightGoalChart.data.datasets[1];
        const futureIndices = window.weeklyGoalWeights ? window.weeklyGoalWeights.map(w => w.index) : [];

        // Reset point radius
        goalDataset.pointRadius = function(context) {
            const index = context.dataIndex;
            // Check if this is a future date (goal weight point)
            if (futureIndices.includes(index)) {
                return 5; // Make future points visible but not too large
            }
            return 3; // Keep past points small
        };

        // Reset point background color
        goalDataset.pointBackgroundColor = function(context) {
            const index = context.dataIndex;
            // Check if this is a future date (goal weight point)
            if (futureIndices.includes(index)) {
                return '#ff6384'; // Red for future points
            }
            return '#36a2eb'; // Blue for past points
        };

        // Reset point border color
        goalDataset.pointBorderColor = function(context) {
            return '#ffffff'; // White border for all points
        };

        // Reset point border width
        goalDataset.pointBorderWidth = 1;

        // Reset point hover radius
        goalDataset.pointHoverRadius = 7;

        // Update the chart
        window.weightGoalChart.update();
    }

    // Hide instructions
    const instructionsElement = document.getElementById('point-selection-instructions');
    if (instructionsElement) {
        instructionsElement.style.display = 'none';
    }
}

// Handle click on the canvas
function handleCanvasClick(event) {
    console.log('Canvas clicked');

    // Get the chart instance
    if (!window.weightGoalChart) {
        console.error('Weight goal chart instance not found');

        // Try to get the chart from the Chart.js registry
        if (window.Chart && window.Chart.instances) {
            const chartInstances = Object.values(window.Chart.instances);
            if (chartInstances.length > 0) {
                // Use the first chart instance found
                window.weightGoalChart = chartInstances[0];
                console.log('Found chart instance:', window.weightGoalChart);
            }
        }

        if (!window.weightGoalChart) {
            alert('Chart not initialized. Please try refreshing the page.');
            return;
        }
    }

    // Get the click position relative to the canvas
    const canvas = event.target;
    const rect = canvas.getBoundingClientRect();
    const x = event.clientX - rect.left;
    const y = event.clientY - rect.top;

    console.log(`Canvas clicked at position: (${x}, ${y})`);

    try {
        // Get the points that were clicked
        let clickedElements;

        // Try different methods to get the clicked elements
        try {
            // Method 1: getElementsAtEventForMode
            clickedElements = window.weightGoalChart.getElementsAtEventForMode(
                event,
                'nearest',
                { intersect: true },
                false
            );
        } catch (error) {
            console.error('Error using getElementsAtEventForMode:', error);

            // Method 2: getElementsAtEvent
            try {
                clickedElements = window.weightGoalChart.getElementsAtEvent(event);
            } catch (error2) {
                console.error('Error using getElementsAtEvent:', error2);

                // Method 3: getDatasetAtEvent
                try {
                    clickedElements = window.weightGoalChart.getDatasetAtEvent(event);
                } catch (error3) {
                    console.error('Error using getDatasetAtEvent:', error3);
                    clickedElements = [];
                }
            }
        }

        console.log('Clicked elements:', clickedElements);

        if (!clickedElements || clickedElements.length === 0) {
            console.log('No chart elements clicked');

            // Try a different approach - find the closest point manually
            if (window.weightGoalChart.data && window.weightGoalChart.data.datasets && window.weightGoalChart.data.datasets.length > 1) {
                const goalDataset = window.weightGoalChart.data.datasets[1];

                // Get the chart area
                const chartArea = window.weightGoalChart.chartArea;

                // Check if the click is within the chart area
                if (x >= chartArea.left && x <= chartArea.right && y >= chartArea.top && y <= chartArea.bottom) {
                    console.log('Click is within chart area');

                    // Find the closest point to the click
                    let closestPoint = null;
                    let closestDistance = Infinity;
                    let closestIndex = -1;

                    // Get the meta data for the goal dataset
                    const meta = window.weightGoalChart.getDatasetMeta(1);

                    if (meta && meta.data) {
                        meta.data.forEach((point, index) => {
                            // Calculate the distance from the click to the point
                            const dx = point.x - x;
                            const dy = point.y - y;
                            const distance = Math.sqrt(dx * dx + dy * dy);

                            // Check if this is the closest point so far
                            if (distance < closestDistance) {
                                closestDistance = distance;
                                closestPoint = point;
                                closestIndex = index;
                            }
                        });
                    }

                    // If we found a close point and it's within a reasonable distance
                    // Use a larger distance threshold since we're making the points bigger
                    if (closestPoint && closestDistance < 30) {
                        console.log(`Found closest point at index ${closestIndex}, distance: ${closestDistance}`);

                        // Create a synthetic clicked element
                        clickedElements = [{
                            datasetIndex: 1,
                            index: closestIndex
                        }];
                    }
                }
            }

            // If we still don't have any clicked elements, return
            if (!clickedElements || clickedElements.length === 0) {
                return;
            }
        }

        // Get the first clicked element
        const clickedElement = clickedElements[0];
        const datasetIndex = clickedElement.datasetIndex;
        const pointIndex = clickedElement.index;

        console.log(`Clicked element: dataset ${datasetIndex}, index ${pointIndex}`);

        // Check if this is a goal weight point (dataset index 1)
        if (datasetIndex !== 1) {
            console.log('This is not a goal weight point');
            return;
        }

        // Find the week number for this point directly from weeklyGoalWeights
        const weeklyPoint = window.weeklyGoalWeights.find(w => w.index === pointIndex);

        if (!weeklyPoint) {
            console.log('This is not a weekly goal point');
            return;
        }

        const weekNumber = weeklyPoint.week;
        console.log(`Found week number ${weekNumber} from weekly goal weights`);

        // Toggle the selection for this week
        const isSelected = selectedWeeks.includes(weekNumber);

        if (isSelected) {
            // Remove from selection
            selectedWeeks = selectedWeeks.filter(week => week !== weekNumber);
            console.log(`Removed week ${weekNumber} from selection`);
        } else {
            // Add to selection
            selectedWeeks.push(weekNumber);
            selectedWeeks.sort((a, b) => a - b);
            console.log(`Added week ${weekNumber} to selection`);
        }

        // Update the chart to show the selection
        updateChartSelection();

        // Update UI
        updateSelectedWeeksUI();

        // Show the weight input container if weeks are selected
        const weightInputContainer = document.getElementById('weight-input-container');
        if (weightInputContainer) {
            if (selectedWeeks.length > 0) {
                weightInputContainer.style.display = 'flex';
                weightInputContainer.style.animation = 'fadeIn 0.3s';

                // Focus the input field
                setTimeout(() => {
                    const weightInput = document.getElementById('custom-weight-input');
                    if (weightInput) {
                        weightInput.focus();
                    }
                }, 300);
            } else {
                weightInputContainer.style.display = 'none';
            }
        }

        // Force a redraw of the chart
        window.weightGoalChart.update();
    } catch (error) {
        console.error('Error handling canvas click:', error);
        alert('Error handling click. Please try again or refresh the page.');
    }
}

// Update the chart to show the selection
function updateChartSelection() {
    if (!window.weightGoalChart || !window.weightGoalChart.data || window.weightGoalChart.data.datasets.length < 2) {
        return;
    }

    const goalDataset = window.weightGoalChart.data.datasets[1];
    const futureIndices = window.weeklyGoalWeights.map(w => w.index);

    // Update the point colors based on selection
    goalDataset.pointBackgroundColor = function(context) {
        const index = context.dataIndex;

        // Check if this is a future date point
        if (futureIndices.includes(index)) {
            // Find the weekly point data
            const weeklyPoint = window.weeklyGoalWeights.find(w => w.index === index);

            if (weeklyPoint) {
                // Check if this week is selected
                const isSelected = selectedWeeks.includes(weeklyPoint.week);

                if (isSelected) {
                    return '#4CAF50'; // Green for selected points
                } else {
                    return '#ff6384'; // Red for unselected points
                }
            }
            return '#ff6384'; // Default red for future points
        }

        // For past points (actual weight)
        return '#36a2eb'; // Blue for past points
    };

    // Update the point border colors
    goalDataset.pointBorderColor = function(context) {
        const index = context.dataIndex;

        // Check if this is a future date point
        if (futureIndices.includes(index)) {
            return '#ffffff'; // White border for future points
        }

        return '#ffffff'; // White border for past points
    };

    // Update the point border width
    goalDataset.pointBorderWidth = function(context) {
        const index = context.dataIndex;

        // Check if this is a future date point
        if (futureIndices.includes(index)) {
            // Find the weekly point data
            const weeklyPoint = window.weeklyGoalWeights.find(w => w.index === index);

            if (weeklyPoint) {
                // Check if this week is selected
                const isSelected = selectedWeeks.includes(weeklyPoint.week);

                if (isSelected) {
                    return 3; // Thicker border for selected points
                }
            }
            return 2; // Normal border for future points
        }

        return 1; // Thin border for past points
    };

    // Update the point radius
    goalDataset.pointRadius = function(context) {
        const index = context.dataIndex;

        // Check if this is a future date point
        if (futureIndices.includes(index)) {
            // Find the weekly point data
            const weeklyPoint = window.weeklyGoalWeights.find(w => w.index === index);

            if (weeklyPoint) {
                // Check if this week is selected
                const isSelected = selectedWeeks.includes(weeklyPoint.week);

                if (isSelected) {
                    return 18; // Larger radius for selected points
                }
            }
            return 15; // Normal radius for future points
        }

        return 3; // Small radius for past points
    };

    // Update the chart
    window.weightGoalChart.update();
}

// Update the UI to show selected weeks
function updateSelectedWeeksUI() {
    console.log('Updating selected weeks UI. Selected weeks:', selectedWeeks);

    // Get the selected weeks container - try different selectors to make sure we find it
    let selectedWeeksContainer = document.getElementById('selected-weeks');

    // If we can't find it by ID, try to find it by text content
    if (!selectedWeeksContainer) {
        const allParagraphs = document.querySelectorAll('p');
        for (const p of allParagraphs) {
            if (p.textContent.includes('No weeks selected') ||
                p.textContent.includes('Selected week') ||
                p.textContent.includes('Selected weeks')) {
                selectedWeeksContainer = p;
                break;
            }
        }
    }

    // If we still can't find it, create a new one
    if (!selectedWeeksContainer) {
        console.error('Could not find selected weeks container, creating a new one');
        selectedWeeksContainer = document.createElement('p');
        selectedWeeksContainer.id = 'selected-weeks';

        // Find the custom weights panel
        const customWeightsPanel = document.getElementById('custom-weights-panel');
        if (customWeightsPanel) {
            // Insert after the instructions paragraph
            const instructionsParagraph = customWeightsPanel.querySelector('#point-selection-instructions');
            if (instructionsParagraph) {
                instructionsParagraph.parentNode.insertBefore(selectedWeeksContainer, instructionsParagraph.nextSibling);
            } else {
                // Just append to the panel
                customWeightsPanel.appendChild(selectedWeeksContainer);
            }
        } else {
            // Just add it to the body
            document.body.appendChild(selectedWeeksContainer);
        }
    }

    const weightInputContainer = document.getElementById('weight-input-container');

    console.log('Selected weeks container:', selectedWeeksContainer);
    console.log('Weight input container:', weightInputContainer);

    if (selectedWeeks.length > 0) {
        // Show selected weeks with better formatting
        if (selectedWeeks.length === 1) {
            selectedWeeksContainer.innerHTML = `<strong>Selected week:</strong> <span class="selected-weeks-list">${selectedWeeks[0]}</span>`;
        } else {
            // Sort weeks for better display
            const sortedWeeks = [...selectedWeeks].sort((a, b) => a - b);

            // Format consecutive weeks as ranges
            const ranges = [];
            let rangeStart = sortedWeeks[0];
            let rangeEnd = rangeStart;

            for (let i = 1; i < sortedWeeks.length; i++) {
                if (sortedWeeks[i] === rangeEnd + 1) {
                    // Continue the current range
                    rangeEnd = sortedWeeks[i];
                } else {
                    // End the current range and start a new one
                    if (rangeStart === rangeEnd) {
                        ranges.push(`${rangeStart}`);
                    } else {
                        ranges.push(`${rangeStart}-${rangeEnd}`);
                    }
                    rangeStart = sortedWeeks[i];
                    rangeEnd = rangeStart;
                }
            }

            // Add the last range
            if (rangeStart === rangeEnd) {
                ranges.push(`${rangeStart}`);
            } else {
                ranges.push(`${rangeStart}-${rangeEnd}`);
            }

            selectedWeeksContainer.innerHTML = `<strong>Selected weeks:</strong> <span class="selected-weeks-list">${ranges.join(', ')}</span>`;
        }

        // Style the selected weeks container
        selectedWeeksContainer.style.display = 'block';
        selectedWeeksContainer.style.backgroundColor = 'rgba(76, 175, 80, 0.1)';
        selectedWeeksContainer.style.padding = '10px';
        selectedWeeksContainer.style.borderRadius = '4px';
        selectedWeeksContainer.style.border = '1px solid rgba(76, 175, 80, 0.3)';
        selectedWeeksContainer.style.marginTop = '10px';
        selectedWeeksContainer.style.marginBottom = '10px';
        selectedWeeksContainer.style.color = 'white';
        selectedWeeksContainer.style.fontWeight = 'normal';

        // Show weight input with animation
        if (weightInputContainer) {
            weightInputContainer.style.display = 'flex';
            weightInputContainer.style.animation = 'fadeIn 0.3s';

            // Focus the input field for better UX
            setTimeout(() => {
                const weightInput = document.getElementById('custom-weight-input');
                if (weightInput) {
                    weightInput.focus();
                }
            }, 300);
        } else {
            console.error('Weight input container not found');

            // Try to create the weight input container if it doesn't exist
            createWeightInputContainer();
        }
    } else {
        // Hide selected weeks
        selectedWeeksContainer.innerHTML = '<em style="color: #aaa;">No weeks selected</em>';
        selectedWeeksContainer.style.backgroundColor = 'transparent';
        selectedWeeksContainer.style.padding = '5px';
        selectedWeeksContainer.style.border = 'none';
        selectedWeeksContainer.style.display = 'block';
        selectedWeeksContainer.style.color = 'white';
        selectedWeeksContainer.style.fontWeight = 'normal';

        if (weightInputContainer) {
            weightInputContainer.style.display = 'none';
        }
    }

    // Add a style for the animation if it doesn't exist
    if (!document.getElementById('selected-weeks-animation')) {
        const style = document.createElement('style');
        style.id = 'selected-weeks-animation';
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(-10px); }
                to { opacity: 1; transform: translateY(0); }
            }

            .selected-weeks-list {
                font-weight: bold;
                color: #4CAF50;
            }

            #selected-weeks {
                transition: all 0.3s ease;
            }
        `;
        document.head.appendChild(style);
    }
}

// Helper function to create the weight input container if it doesn't exist
function createWeightInputContainer() {
    if (document.getElementById('weight-input-container')) {
        return; // Already exists
    }

    // Create the container
    const container = document.createElement('div');
    container.id = 'weight-input-container';
    container.style.display = 'none';
    container.style.flexDirection = 'row';
    container.style.alignItems = 'center';
    container.style.marginTop = '10px';
    container.style.marginBottom = '10px';

    // Create the input field
    const input = document.createElement('input');
    input.type = 'number';
    input.id = 'custom-weight-input';
    input.placeholder = 'Enter weight (lbs)';
    input.step = '0.1';
    input.min = '0';
    input.style.flex = '1';
    input.style.marginRight = '10px';
    input.style.padding = '8px';
    input.style.borderRadius = '4px';
    input.style.border = '1px solid #ccc';

    // Create the apply button
    const applyButton = document.createElement('button');
    applyButton.id = 'apply-custom-weight';
    applyButton.textContent = 'Apply';
    applyButton.style.padding = '8px 16px';
    applyButton.style.backgroundColor = '#4CAF50';
    applyButton.style.color = 'white';
    applyButton.style.border = 'none';
    applyButton.style.borderRadius = '4px';
    applyButton.style.cursor = 'pointer';
    applyButton.onclick = saveCustomWeights;

    // Add elements to the container
    container.appendChild(input);
    container.appendChild(applyButton);

    // Find the custom weights panel
    const customWeightsPanel = document.getElementById('custom-weights-panel');
    if (customWeightsPanel) {
        // Find the selected weeks container
        const selectedWeeksContainer = document.getElementById('selected-weeks');
        if (selectedWeeksContainer) {
            // Insert after the selected weeks container
            selectedWeeksContainer.parentNode.insertBefore(container, selectedWeeksContainer.nextSibling);
        } else {
            // Just append to the panel
            customWeightsPanel.appendChild(container);
        }
    } else {
        // Just add it to the body
        document.body.appendChild(container);
    }
}

// Load custom goal weights from the server
async function loadCustomGoalWeights() {
    try {
        // Get the user ID from the user selector if available, otherwise default to 1
        const userSelector = document.getElementById('user-selector');
        const userId = userSelector ? userSelector.value : 1;

        console.log('Loading custom goal weights for user ID:', userId);

        const response = await fetch(`/api/custom-goal-weights?user_id=${userId}`);
        if (!response.ok) {
            // If the server returns 404, it might be because the endpoint isn't available yet
            // In this case, we'll just log the error and continue without custom weights
            console.error('Failed to load custom goal weights:', response.status);
            return;
        }

        customGoalWeights = await response.json();
        console.log('Loaded custom goal weights:', customGoalWeights);

        // Update the chart with custom goal weights
        updateChartWithCustomWeights();
    } catch (error) {
        console.error('Error loading custom goal weights:', error);
        // Don't throw the error, just log it and continue without custom weights
    }
}

// Update the chart with custom goal weights
function updateChartWithCustomWeights() {
    // This function will be called after the chart is rendered
    // It will update the chart to use custom goal weights
    if (window.weightGoalChart && customGoalWeights.length > 0) {
        const chart = window.weightGoalChart;
        const goalDataset = chart.data.datasets.find(ds => ds.label === 'Goal Weight Path (lbs)');

        if (goalDataset) {
            console.log('Updating chart with custom goal weights:', customGoalWeights);
            console.log('Weekly increment dates:', window.weeklyIncrementDates);
            console.log('Goal dataset data:', goalDataset.data);

            // For each custom weight, update the corresponding point in the chart
            customGoalWeights.forEach(customWeight => {
                const weekNumber = customWeight.week_number;
                const weight = customWeight.weight;

                console.log(`Processing custom weight for week ${weekNumber}: ${weight} lbs`);

                // Find the weekly point data
                const weeklyPoint = window.weeklyGoalWeights.find(w => w.week === weekNumber);

                if (weeklyPoint) {
                    const dataIndex = weeklyPoint.index;
                    console.log(`Found matching weekly point at index ${dataIndex}`);

                    if (dataIndex !== -1 && dataIndex < goalDataset.data.length) {
                        // Update the point with the custom weight
                        goalDataset.data[dataIndex].y = weight;
                        console.log(`Updated point at index ${dataIndex} to ${weight} lbs`);

                        // Mark this point as custom
                        if (!goalDataset.data[dataIndex].custom) {
                            goalDataset.data[dataIndex].custom = true;

                            // Add a visual indicator for custom points
                            if (!goalDataset.pointBackgroundColor) {
                                goalDataset.pointBackgroundColor = [];
                                for (let i = 0; i < goalDataset.data.length; i++) {
                                    goalDataset.pointBackgroundColor.push(goalDataset.backgroundColor);
                                }
                            }

                            // Set the custom point color
                            goalDataset.pointBackgroundColor[dataIndex] = '#FFD700'; // Gold color for custom points
                            console.log(`Marked point at index ${dataIndex} as custom`);
                        }
                    }
                } else {
                    console.log(`No matching weekly point found for week ${weekNumber}`);
                }
            });

            // Update the chart
            chart.update();
            console.log('Chart updated with custom goal weights');
        }
    }
}

// Save custom weights for selected weeks
async function saveCustomWeights() {
    if (selectedWeeks.length === 0) {
        alert('Please select at least one week to adjust');
        return;
    }

    const weightInput = document.getElementById('custom-weight-input');
    const weight = parseFloat(weightInput.value);

    if (isNaN(weight) || weight <= 0) {
        alert('Please enter a valid positive weight');
        return;
    }

    // Get the user ID from the user selector if available, otherwise default to 1
    const userSelector = document.getElementById('user-selector');
    const userId = userSelector ? userSelector.value : 1;

    // Prepare data for saving
    const customWeightsToSave = [];

    selectedWeeks.forEach(weekNumber => {
        // Get the date for this week
        const weeklyPoint = window.weeklyGoalWeights.find(w => w.week === weekNumber);
        let targetDate = null;

        if (weeklyPoint && weeklyPoint.date) {
            // Format the date as YYYY-MM-DD
            const date = new Date(weeklyPoint.date);
            if (!isNaN(date.getTime())) {
                targetDate = date.toISOString().split('T')[0];
            }
        }

        // If we couldn't get a date from the weekly point, try the weeklyIncrementDates array
        if (!targetDate && weeklyIncrementDates && weeklyIncrementDates[weekNumber]) {
            targetDate = weeklyIncrementDates[weekNumber];
        }

        // If we still don't have a date, use today's date
        if (!targetDate) {
            targetDate = new Date().toISOString().split('T')[0];
        }

        customWeightsToSave.push({
            weekNumber,
            targetDate,
            weight
        });
    });

    if (customWeightsToSave.length === 0) {
        alert('No valid weeks selected');
        return;
    }

    try {
        console.log(`Saving custom goal weights for user ID: ${userId}`);
        console.log('Custom weights to save:', customWeightsToSave);

        // Save to server
        const response = await fetch('/api/custom-goal-weights/multiple', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                customWeights: customWeightsToSave,
                user_id: userId
            })
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to save custom goal weights: ${errorText}`);
        }

        const savedWeights = await response.json();
        console.log('Saved custom goal weights:', savedWeights);

        // Update local data
        savedWeights.forEach(savedWeight => {
            const existingIndex = customGoalWeights.findIndex(cw =>
                cw.user_id === savedWeight.user_id && cw.week_number === savedWeight.week_number
            );

            if (existingIndex !== -1) {
                customGoalWeights[existingIndex] = savedWeight;
            } else {
                customGoalWeights.push(savedWeight);
            }
        });

        // Update the chart
        updateChartWithCustomWeights();

        // Clear selection
        selectedWeeks = [];
        updateSelectedWeeksUI();

        // Reset UI
        weightInput.value = '';

        // Reload the chart to show the updated goal weights
        if (typeof loadAndRenderWeightChart === 'function') {
            loadAndRenderWeightChart();
        } else if (window.loadAndRenderWeightChart) {
            window.loadAndRenderWeightChart();
        }

        // Show success message
        alert('Custom goal weights saved successfully');
    } catch (error) {
        console.error('Error saving custom goal weights:', error);
        alert('Failed to save custom goal weights: ' + error.message);
    }
}

// Cancel custom weight editing
function cancelCustomWeights() {
    // Clear selection
    selectedWeeks = [];
    updateSelectedWeeksUI();

    // Reset UI
    document.getElementById('custom-weight-input').value = '';

    // Exit edit mode
    toggleEditMode();
}

// Reset custom weights (delete all custom weights)
async function resetCustomWeights() {
    if (!confirm('Are you sure you want to reset all custom goal weights? This will revert to the calculated linear progression.')) {
        return;
    }

    try {
        // Get the user ID from the user selector if available, otherwise default to 1
        const userSelector = document.getElementById('user-selector');
        const userId = userSelector ? userSelector.value : 1;

        console.log(`Resetting custom goal weights for user ID: ${userId}`);

        const response = await fetch(`/api/custom-goal-weights?user_id=${userId}`, {
            method: 'DELETE'
        });

        if (!response.ok) {
            throw new Error('Failed to reset custom goal weights');
        }

        // Clear local data
        customGoalWeights = [];

        // Reload the chart to show the default goal weights
        loadAndRenderWeightChart();

        // Exit edit mode
        toggleEditMode();

        // Show success message
        alert('Custom goal weights reset successfully');
    } catch (error) {
        console.error('Error resetting custom goal weights:', error);
        alert('Failed to reset custom goal weights: ' + error.message);
    }
}

// Add data-week-number attribute to goal weight points
function addWeekNumbersToPoints() {
    // This function will be called after the chart is rendered
    // It will add week numbers to the goal weight points for selection
    if (window.weightGoalChart) {
        const chart = window.weightGoalChart;
        const canvas = chart.canvas;

        // Wait for chart animation to complete
        setTimeout(() => {
            // Find all goal weight points
            const goalPoints = canvas.parentElement.querySelectorAll('.goal-weight-point');

            console.log(`Found ${goalPoints.length} goal weight points to add week numbers to`);

            // Add week number as data attribute
            if (window.weeklyGoalWeights && window.weeklyGoalWeights.length > 0) {
                goalPoints.forEach((point, index) => {
                    // Find the corresponding weekly goal weight
                    const weeklyPoint = window.weeklyGoalWeights.find(w => w.index === index);

                    if (weeklyPoint) {
                        point.dataset.weekNumber = weeklyPoint.week;
                        console.log(`Added week number ${weeklyPoint.week} to point at index ${index}`);
                    } else {
                        console.log(`No weekly point found for index ${index}`);
                    }
                });
            } else {
                console.log('No weekly goal weights available');
            }
        }, 500);
    }
}

// Export functions for use in other files
window.customGoalWeights = {
    init: initCustomGoalWeights,
    load: loadCustomGoalWeights,
    update: updateChartWithCustomWeights,
    addWeekNumbers: addWeekNumbersToPoints
};
