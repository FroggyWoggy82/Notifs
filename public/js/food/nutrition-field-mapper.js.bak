/**
 * Nutrition Field Mapper
 *
 * This module provides mapping between Cronometer parser field names and database column names,
 * as well as utility functions for handling nutrition data.
 */

// Create a namespace for the nutrition field mapper
window.NutritionFieldMapper = (function() {
    // Map of JavaScript property names to database column names
    const fieldMappings = {
        // Basic fields
        name: 'name',
        calories: 'calories',
        amount: 'amount',
        protein: 'protein',
        fats: 'fats',
        carbs: 'carbohydrates',
        carbohydrates: 'carbohydrates', // Alias
        price: 'price',
        package_amount: 'package_amount',

        // General
        alcohol: 'alcohol',
        caffeine: 'caffeine',
        water: 'water',

        // Carbohydrates breakdown
        fiber: 'fiber',
        starch: 'starch',
        sugars: 'sugars',
        addedSugars: 'added_sugars',
        added_sugars: 'added_sugars', // Alias
        netCarbs: 'net_carbs',
        net_carbs: 'net_carbs', // Alias

        // Lipids
        fat: 'fats', // Alias for fats
        saturated: 'saturated',
        monounsaturated: 'monounsaturated',
        polyunsaturated: 'polyunsaturated',
        omega3: 'omega3',
        omega_3: 'omega3', // Alias for omega3
        omega6: 'omega6',
        omega_6: 'omega6', // Alias for omega6
        transFat: 'trans',
        trans_fat: 'trans', // Alias for trans
        cholesterol: 'cholesterol',

        // Vitamins
        vitaminA: 'vitamin_a',
        vitamin_a: 'vitamin_a', // Alias
        vitaminB1: 'vitamin_b1',
        thiamine: 'vitamin_b1', // Map thiamine to vitamin_b1
        vitaminB2: 'vitamin_b2',
        riboflavin: 'vitamin_b2', // Map riboflavin to vitamin_b2
        vitaminB3: 'vitamin_b3',
        niacin: 'vitamin_b3', // Map niacin to vitamin_b3
        vitaminB5: 'vitamin_b5',
        pantothenic_acid: 'vitamin_b5', // Map pantothenic_acid to vitamin_b5
        vitaminB6: 'vitamin_b6',
        vitamin_b6: 'vitamin_b6', // Alias
        vitaminB12: 'vitamin_b12',
        vitamin_b12: 'vitamin_b12', // Alias
        vitaminC: 'vitamin_c',
        vitamin_c: 'vitamin_c', // Alias
        vitaminD: 'vitamin_d',
        vitamin_d: 'vitamin_d', // Alias
        vitaminE: 'vitamin_e',
        vitamin_e: 'vitamin_e', // Alias
        vitaminK: 'vitamin_k',
        vitamin_k: 'vitamin_k', // Alias
        folate: 'folate',
        biotin: 'biotin',

        // Minerals
        calcium: 'calcium',
        copper: 'copper',
        iron: 'iron',
        magnesium: 'magnesium',
        manganese: 'manganese',
        phosphorus: 'phosphorus',
        potassium: 'potassium',
        selenium: 'selenium',
        sodium: 'sodium',
        zinc: 'zinc',

        // Amino acids
        histidine: 'histidine',
        isoleucine: 'isoleucine',
        leucine: 'leucine',
        lysine: 'lysine',
        methionine: 'methionine',
        phenylalanine: 'phenylalanine',
        threonine: 'threonine',
        tryptophan: 'tryptophan',
        tyrosine: 'tyrosine',
        valine: 'valine',
        cystine: 'cystine'
    };

    /**
     * Convert a JavaScript object with nutrition data to a format suitable for the database
     * @param {Object} data - Nutrition data object
     * @returns {Object} - Object with database column names as keys
     */
    function toDbFormat(data) {
        console.log('[NutritionFieldMapper] Converting to DB format:', data);
        const result = {};

        for (const [key, value] of Object.entries(data)) {
            // Skip null or undefined values
            if (value === null || value === undefined) {
                console.log(`[NutritionFieldMapper] Skipping null/undefined value for key: ${key}`);
                continue;
            }

            // Get the corresponding database column name
            const columnName = fieldMappings[key];

            // Skip if no mapping exists
            if (!columnName) {
                console.log(`[NutritionFieldMapper] No mapping found for key: ${key}`);
                continue;
            }

            // Skip duplicate fields (e.g., if both omega3 and omega_3 are present)
            if (result[columnName] !== undefined) {
                console.log(`[NutritionFieldMapper] Skipping duplicate field: ${key} -> ${columnName}`);
                continue;
            }

            // Convert string numbers to actual numbers
            let finalValue = value;
            if (typeof finalValue === 'string' && !isNaN(parseFloat(finalValue))) {
                finalValue = parseFloat(finalValue);
                console.log(`[NutritionFieldMapper] Converted string to number: ${key} = ${value} -> ${finalValue}`);
            }

            result[columnName] = finalValue;
            console.log(`[NutritionFieldMapper] Mapped field: ${key} -> ${columnName} = ${finalValue}`);
        }

        console.log('[NutritionFieldMapper] Final DB format:', result);
        return result;
    }

    /**
     * Convert a database object to a JavaScript object with nutrition data
     * @param {Object} dbData - Object with database column names as keys
     * @returns {Object} - Nutrition data object
     */
    function fromDbFormat(dbData) {
        const result = {};

        // Create a reverse mapping (database column name to JavaScript property name)
        const reverseMapping = {};
        for (const [jsKey, dbKey] of Object.entries(fieldMappings)) {
            // Skip aliases (keys that map to the same database column)
            if (!reverseMapping[dbKey] || jsKey.length < reverseMapping[dbKey].length) {
                reverseMapping[dbKey] = jsKey;
            }
        }

        for (const [dbKey, value] of Object.entries(dbData)) {
            // Skip null or undefined values
            if (value === null || value === undefined) continue;

            // Get the corresponding JavaScript property name
            const jsKey = reverseMapping[dbKey];

            // Skip if no mapping exists
            if (!jsKey) continue;

            result[jsKey] = value;
        }

        return result;
    }

    /**
     * Get all field mappings
     * @returns {Object} - Field mappings object
     */
    function getFieldMappings() {
        return { ...fieldMappings };
    }

    // Public API
    return {
        toDbFormat,
        fromDbFormat,
        getFieldMappings
    };
})();
