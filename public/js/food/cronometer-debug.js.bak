/**
 * Cronometer Debug
 * 
 * This script adds a debug button to the Cronometer parser to help diagnose issues
 * with micronutrient data not being saved to the database.
 */

(function() {
    // Wait for the DOM to be fully loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the Cronometer debug
        initCronometerDebug();
    });

    /**
     * Initialize the Cronometer debug
     */
    function initCronometerDebug() {
        console.log('[Cronometer Debug] Initializing...');

        // Add debug buttons to all Cronometer parsers
        addDebugButtonsToCronometerParsers();

        // Add a mutation observer to add debug buttons to new Cronometer parsers
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                    // Check if any of the added nodes are Cronometer parsers
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === Node.ELEMENT_NODE) {
                            // Check if the node is a Cronometer parser
                            const cronometerParsers = node.querySelectorAll('.cronometer-text-paste-container');
                            if (cronometerParsers.length > 0) {
                                // Add debug buttons to the Cronometer parsers
                                cronometerParsers.forEach(function(parser) {
                                    addDebugButtonToCronometerParser(parser);
                                });
                            }

                            // Check if the node contains Cronometer parsers
                            if (node.querySelector('.cronometer-text-paste-container')) {
                                // Add debug buttons to the Cronometer parsers
                                const parsers = node.querySelectorAll('.cronometer-text-paste-container');
                                parsers.forEach(function(parser) {
                                    addDebugButtonToCronometerParser(parser);
                                });
                            }
                        }
                    });
                }
            });
        });

        // Start observing the document
        observer.observe(document.body, { childList: true, subtree: true });

        console.log('[Cronometer Debug] Initialized');
    }

    /**
     * Add debug buttons to all Cronometer parsers
     */
    function addDebugButtonsToCronometerParsers() {
        console.log('[Cronometer Debug] Adding debug buttons to Cronometer parsers');

        // Get all Cronometer parsers
        const cronometerParsers = document.querySelectorAll('.cronometer-text-paste-container');

        // Add debug buttons to each parser
        cronometerParsers.forEach(function(parser) {
            addDebugButtonToCronometerParser(parser);
        });
    }

    /**
     * Add a debug button to a Cronometer parser
     * @param {HTMLElement} parser - The Cronometer parser element
     */
    function addDebugButtonToCronometerParser(parser) {
        // Check if the parser already has a debug button
        if (parser.querySelector('.cronometer-debug-button')) {
            return;
        }

        console.log('[Cronometer Debug] Adding debug button to Cronometer parser:', parser);

        // Create the debug button
        const debugButton = document.createElement('button');
        debugButton.type = 'button';
        debugButton.className = 'cronometer-debug-button';
        debugButton.textContent = 'Debug Nutrition Data';
        debugButton.style.backgroundColor = '#333';
        debugButton.style.color = '#fff';
        debugButton.style.border = '1px solid #555';
        debugButton.style.padding = '5px 10px';
        debugButton.style.marginTop = '5px';
        debugButton.style.cursor = 'pointer';
        debugButton.style.fontSize = '12px';

        // Add click event
        debugButton.addEventListener('click', function() {
            debugCronometerParser(parser);
        });

        // Add the debug button to the parser
        parser.appendChild(debugButton);
    }

    /**
     * Debug a Cronometer parser
     * @param {HTMLElement} parser - The Cronometer parser element
     */
    function debugCronometerParser(parser) {
        console.log('[Cronometer Debug] Debugging Cronometer parser:', parser);

        // Get the ingredient item
        const ingredientItem = parser.closest('.ingredient-item');
        if (!ingredientItem) {
            console.warn('[Cronometer Debug] No ingredient item found');
            alert('No ingredient item found');
            return;
        }

        // Get the complete nutrition data
        const completeNutritionData = ingredientItem.dataset.completeNutritionData;
        if (!completeNutritionData) {
            console.warn('[Cronometer Debug] No complete nutrition data found');
            alert('No complete nutrition data found. Please parse Cronometer data first.');
            return;
        }

        // Parse the complete nutrition data
        const nutritionData = JSON.parse(completeNutritionData);

        // Get the database format data
        const dbFormatData = ingredientItem.dataset.dbFormatNutritionData
            ? JSON.parse(ingredientItem.dataset.dbFormatNutritionData)
            : window.NutritionFieldMapper
                ? window.NutritionFieldMapper.toDbFormat(nutritionData)
                : {};

        // Create a debug panel
        const debugPanel = document.createElement('div');
        debugPanel.className = 'cronometer-debug-panel';
        debugPanel.style.backgroundColor = '#222';
        debugPanel.style.color = '#fff';
        debugPanel.style.padding = '10px';
        debugPanel.style.marginTop = '10px';
        debugPanel.style.border = '1px solid #444';
        debugPanel.style.maxHeight = '300px';
        debugPanel.style.overflowY = 'auto';
        debugPanel.style.fontSize = '12px';
        debugPanel.style.fontFamily = 'monospace';

        // Add the debug information
        debugPanel.innerHTML = `
            <h4 style="margin-top: 0; margin-bottom: 10px; color: #00ff00;">Cronometer Debug Information</h4>
            <p><strong>Complete Nutrition Data:</strong></p>
            <pre style="margin: 0 0 10px 0; white-space: pre-wrap;">${JSON.stringify(nutritionData, null, 2)}</pre>
            <p><strong>Database Format Data:</strong></p>
            <pre style="margin: 0 0 10px 0; white-space: pre-wrap;">${JSON.stringify(dbFormatData, null, 2)}</pre>
            <p><strong>Hidden Fields:</strong></p>
            <ul style="margin: 0 0 10px 0; padding-left: 20px;">
                ${getHiddenFieldsHTML(ingredientItem)}
            </ul>
            <p><strong>Detailed Nutrition Fields:</strong></p>
            <ul style="margin: 0 0 10px 0; padding-left: 20px;">
                ${getDetailedNutritionFieldsHTML(ingredientItem)}
            </ul>
        `;

        // Add a close button
        const closeButton = document.createElement('button');
        closeButton.type = 'button';
        closeButton.textContent = 'Close';
        closeButton.style.backgroundColor = '#333';
        closeButton.style.color = '#fff';
        closeButton.style.border = '1px solid #555';
        closeButton.style.padding = '5px 10px';
        closeButton.style.marginTop = '10px';
        closeButton.style.cursor = 'pointer';
        closeButton.style.fontSize = '12px';

        // Add click event
        closeButton.addEventListener('click', function() {
            debugPanel.remove();
        });

        // Add the close button to the debug panel
        debugPanel.appendChild(closeButton);

        // Add the debug panel to the parser
        parser.appendChild(debugPanel);
    }

    /**
     * Get HTML for hidden fields
     * @param {HTMLElement} ingredientItem - The ingredient item element
     * @returns {string} - HTML string
     */
    function getHiddenFieldsHTML(ingredientItem) {
        // Get all hidden fields
        const hiddenFields = ingredientItem.querySelectorAll('input[type="hidden"]');

        // Create HTML
        let html = '';
        hiddenFields.forEach(function(field) {
            html += `<li><strong>${field.className}:</strong> ${field.value}</li>`;
        });

        return html || '<li>No hidden fields found</li>';
    }

    /**
     * Get HTML for detailed nutrition fields
     * @param {HTMLElement} ingredientItem - The ingredient item element
     * @returns {string} - HTML string
     */
    function getDetailedNutritionFieldsHTML(ingredientItem) {
        // Get the detailed nutrition panel
        const detailedNutritionPanel = ingredientItem.querySelector('.detailed-nutrition-panel');
        if (!detailedNutritionPanel) {
            return '<li>No detailed nutrition panel found</li>';
        }

        // Get all input fields
        const inputFields = detailedNutritionPanel.querySelectorAll('input');

        // Create HTML
        let html = '';
        inputFields.forEach(function(field) {
            html += `<li><strong>${field.id || field.className}:</strong> ${field.value}</li>`;
        });

        return html || '<li>No detailed nutrition fields found</li>';
    }
})();
